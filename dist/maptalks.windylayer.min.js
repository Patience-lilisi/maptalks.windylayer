/*!
 * maptalks.windylayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.23.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function n(t){var n=100,r=[NaN,NaN,null],a=(Math.pow(10,-5.2),function(t,e,n,r,a,o){var i=1-t,f=1-e,u=i*f,s=t*f,h=i*e,c=t*e,d=n[0]*u+r[0]*s+a[0]*h+o[0]*c,p=n[1]*u+r[1]*s+a[1]*h+o[1]*c;return[d,p,Math.sqrt(d*d+p*p)]}),o=function(t,e){var n=t.data,r=e.data;return{header:t.header,data:function(t){return[n[t],r[t]]},interpolate:a}},i=function(t){var e=null,n=null,r=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":e=t;break;case"2,3":n=t;break;default:r=t}}),o(e,n)},f=function(t,e){function n(t,e){var n,a=s(t-o,360)/h,i=(f-e)/c,d=Math.floor(a),p=d+1,l=Math.floor(i),g=l+1;if(n=y[l]){var v=n[d],w=n[p];if(u(v)&&u(w)&&(n=y[g])){var m=n[d],b=n[p];if(u(m)&&u(b))return r.interpolate(a-d,i-l,v,w,m,b)}}return null}var r=i(t),a=r.header,o=a.lo1,f=a.la1,h=a.dx,c=a.dy,d=a.nx,p=a.ny,l=new Date(a.refTime);l.setHours(l.getHours()+a.forecastTime);for(var y=[],g=0,v=Math.floor(d*h)>=360,w=0;w<p;w++){for(var m=[],b=0;b<d;b++,g++)m[b]=r.data(g);v&&m.push(m[0]),y[w]=m}e({date:l,interpolate:n})},u=function(t){return null!==t&&void 0!==t},s=function(t,e){return t-e*Math.floor(t/e)},h=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},c=function(t,e,n,r,a,o,i,f){var u=i[0]*o,s=i[1]*o,h=d(t,e,n,r,a,f);return i[0]=h[0]*u+h[2]*s,i[1]=h[1]*u+h[3]*s,i},d=function(t,e,n,r,a,o){var i=2*Math.PI,f=Math.pow(10,-5.2),u=e<0?f:-f,s=n<0?f:-f,h=m(n,e+u,o),c=m(n+s,e,o),d=Math.cos(n/360*i);return[(h[0]-r)/u/d,(h[1]-a)/u/d,(c[0]-r)/s,(c[1]-a)/s]},p=function(t,e,n){function a(e,n){var a=t[Math.round(e)];return a&&a[Math.round(n)]||r}a.release=function(){t=[]},a.randomize=function(t){var n,r,o=0;do{n=Math.round(Math.floor(Math.random()*e.width)+e.x),r=Math.round(Math.floor(Math.random()*e.height)+e.y)}while(null===a(n,r)[2]&&o++<30);return t.x=n,t.y=r,t},n(e,a)},l=function(t,e,n){var r=t[0],a=t[1],o=Math.round(r[0]),i=Math.max(Math.floor(r[1],0),0);Math.min(Math.ceil(a[0],e),e-1);return{x:o,y:i,xMax:e,yMax:Math.min(Math.ceil(a[1],n),n-1),width:e,height:n}},y=function(t){return t/180*Math.PI},g=function(t){return t/(Math.PI/180)},v=function(t,e,n){var r=n.east-n.west,a=n.width/g(r)*360/(2*Math.PI),o=a/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),i=n.height+o,f=(i-e)/a,u=180/Math.PI*(2*Math.atan(Math.exp(f))-Math.PI/2);return[g(n.west)+t/n.width*g(r),u]},w=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},m=function(t,e,n){var r=w(n.south),a=w(n.north),o=n.width/(n.east-n.west),i=n.height/(a-r),f=w(y(t)),u=(y(e)-n.west)*o,f=(a-f)*i;return[u,f]},b=function(t,e,n,r){function a(r){for(var a=[],u=e.y;u<=e.yMax;u+=2){var s=v(r,u,n);if(s){var h=s[0],d=s[1];if(isFinite(h)){var p=t.interpolate(h,d);p&&(p=c(o,h,d,r,u,i,p,n),a[u+1]=a[u]=p)}}}f[r+1]=f[r]=a}var o={},i=.011,f=[],u=e.x;!function t(){for(var n=Date.now();u<e.width;)if(a(u),u+=2,Date.now()-n>1e3)return void setTimeout(t,25);p(f,e,r)}()},M=function(r,a){function o(t){return parseInt(u(t).substring(0,2),16)}function i(t){return parseInt(u(t).substring(2,4),16)}function f(t){return parseInt(u(t).substring(4,6),16)}function u(t){return"#"==t.charAt(0)?t.substring(1,7):t}function s(){p.forEach(function(t){t.length=0}),y.forEach(function(t){t.age>n&&(a.randomize(t).age=0);var e=t.x,r=t.y,o=a(e,r),i=o[2];if(null===i)t.age=n;else{var f=e+o[0],u=r+o[1];null!==a(f,u)[2]?(t.xt=f,t.yt=u,p[d.indexFor(i)].push(t)):(t.x=f,t.y=u)}t.age+=1})}function c(){var t=v.globalCompositeOperation;v.globalCompositeOperation="destination-in",v.fillRect(r.x,r.y,r.width,r.height),v.globalCompositeOperation=t,p.forEach(function(t,e){t.length>0&&(v.beginPath(),v.strokeStyle=d[e],t.forEach(function(t){v.moveTo(t.x,t.y),v.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),v.stroke())})}var d=function(t,e){var n=["rgba("+o("#00ffff")+", "+i("#00ffff")+", "+f("#00ffff")+", 0.5)","rgba("+o("#64f0ff")+", "+i("#64f0ff")+", "+f("#64f0ff")+", 0.5)","rgba("+o("#87e1ff")+", "+i("#87e1ff")+", "+f("#87e1ff")+", 0.5)","rgba("+o("#a0d0ff")+", "+i("#a0d0ff")+", "+f("#a0d0ff")+", 0.5)","rgba("+o("#b5c0ff")+", "+i("#b5c0ff")+", "+f("#b5c0ff")+", 0.5)","rgba("+o("#c6adff")+", "+i("#c6adff")+", "+f("#c6adff")+", 0.5)","rgba("+o("#d49bff")+", "+i("#d49bff")+", "+f("#d49bff")+", 0.5)","rgba("+o("#e185ff")+", "+i("#e185ff")+", "+f("#e185ff")+", 0.5)","rgba("+o("#ec6dff")+", "+i("#ec6dff")+", "+f("#ec6dff")+", 0.5)","rgba("+o("#ff1edb")+", "+i("#ff1edb")+", "+f("#ff1edb")+", 0.5)"];return n.indexFor=function(t){return Math.floor(Math.min(t,e)/e*(n.length-1))},n}(10,40),p=d.map(function(){return[]}),l=Math.round(r.width*r.height*(1/30));h()&&(l*=.75);for(var y=[],g=0;g<l;g++)y.push(a.randomize({age:Math.floor(Math.random()*n)+0}));var v=t.canvas.getContext("2d");v.lineWidth=.8,v.fillStyle="rgba(0, 0, 0, 0.97)",function n(){s(),c(),t.onDraw(),O.timer=e.Util.requestAnimFrame(n)}()},x=function(e,n,r,a){var o={south:y(a[0][1]),north:y(a[1][1]),east:y(a[1][0]),west:y(a[0][0]),width:n,height:r};_(),f(t.data,function(t){b(t,l(e,n,r),o,function(t,e){O.field=e,M(t,e)})})},_=function(){O.field&&O.field.release(),O.timer&&e.Util.cancelAnimFrame(O.timer)},O={params:t,start:x,stop:_};return O}function r(t,e){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var a=n[r],o=Object.getOwnPropertyDescriptor(e,a);o&&o.configurable&&void 0===t[a]&&Object.defineProperty(t,a,o)}return t}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var f=function(t){function e(n,r,i){a(this,e);var f=o(this,t.call(this,n,i));return f._data=r,f}return i(e,t),e.prototype.getData=function(){return this._data},e.prototype.setData=function(t){return this._data=t,this.redraw(),this},e.prototype.redraw=function(){return this._getRenderer()&&this._getRenderer()._redraw(),this},e.prototype.toJSON=function(){return{type:"WindyLayer",id:this.getId(),options:this.config(),data:this.getData()}},e.fromJSON=function(t){return t&&"WindyLayer"===t.type?new e(t.id,t.data,t.options):null},e}(e.Layer);f.registerRenderer("canvas",function(t){function e(){return a(this,e),o(this,t.apply(this,arguments))}return i(e,t),e.prototype.draw=function(){var t=this;this.canvas?(this.prepareCanvas(),this._windy.start.apply(this._windy,this._getWindExtents())):(this.prepareCanvas(),this._windy=new n({canvas:this.canvas,data:this.layer.getData(),onDraw:function(){t.requestMapToRender()}}),this._windy.start.apply(this._windy,this._getWindExtents()))},e.prototype._getWindExtents=function(){var t=this.getMap(),e=t.getExtent();return[[[0,0],[t.width,t.height]],t.width,t.height,[[e.xmin,e.ymin],[e.xmax,e.ymax]]]},e.prototype._redraw=function(){this.prepareRender(),this.draw()},e.prototype.onRemove=function(){this._windy.stop(),delete this._windy},e.prototype.onDragRotateStart=function(){this._windy.stop()},e.prototype.onMoveStart=function(){this._windy.stop()},e.prototype.onZoomStart=function(){this._windy.stop()},e.prototype.onZoomEnd=function(e){t.prototype.onZoomEnd.call(this,e)},e}(e.renderer.CanvasRenderer)),t.WindyLayer=f,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.windylayer v0.1.0, requires maptalks@^0.23.0.")});