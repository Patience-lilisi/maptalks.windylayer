/*!
 * maptalks.windylayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function n(t){var n=.011,r=10,a=40,o=100,i=.8,f=1/30,u=.75,s=[NaN,NaN,null],h=(Math.pow(10,-5.2),function(t,e,n,r,a,o){var i=1-t,f=1-e,u=i*f,s=t*f,h=i*e,c=t*e,d=n[0]*u+r[0]*s+a[0]*h+o[0]*c,l=n[1]*u+r[1]*s+a[1]*h+o[1]*c;return[d,l,Math.sqrt(d*d+l*l)]}),c=function(t,e){var n=t.data,r=e.data;return{header:t.header,data:function(t){return[n[t],r[t]]},interpolate:h}},d=function(t){var e=null,n=null,r=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":e=t;break;case"2,3":n=t;break;default:r=t}}),c(e,n)},l=function(t,e){function n(t,e){var n,a=y(t-o,360)/f,s=(i-e)/u,h=Math.floor(a),c=h+1,d=Math.floor(s),g=d+1;if(n=l[d]){var v=n[h],m=n[c];if(p(v)&&p(m)&&(n=l[g])){var w=n[h],b=n[c];if(p(w)&&p(b))return r.interpolate(a-h,s-d,v,m,w,b)}}return null}var r=d(t),a=r.header,o=a.lo1,i=a.la1,f=a.dx,u=a.dy,s=a.nx,h=a.ny,c=new Date(a.refTime);c.setHours(c.getHours()+a.forecastTime);for(var l=[],g=0,v=Math.floor(s*f)>=360,m=0;m<h;m++){for(var w=[],b=0;b<s;b++,g++)w[b]=r.data(g);v&&w.push(w[0]),l[m]=w}e({date:c,interpolate:n})},p=function(t){return null!==t&&void 0!==t},y=function(t,e){return t-e*Math.floor(t/e)},g=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},v=function(t,e,n,r,a,o,i,f){var u=i[0]*o,s=i[1]*o,h=m(t,e,n,r,a,f);return i[0]=h[0]*u+h[2]*s,i[1]=h[1]*u+h[3]*s,i},m=function(t,e,n,r,a,o){var i=2*Math.PI,f=Math.pow(10,-5.2),u=e<0?f:-f,s=n<0?f:-f,h=E(n,e+u,o),c=E(n+s,e,o),d=Math.cos(n/360*i);return[(h[0]-r)/u/d,(h[1]-a)/u/d,(c[0]-r)/s,(c[1]-a)/s]},w=function(t,e,n){function r(e,n){var r=t[Math.round(e)];return r&&r[Math.round(n)]||s}r.release=function(){t=[]},r.randomize=function(t){var n,a,o=0;do n=Math.round(Math.floor(Math.random()*e.width)+e.x),a=Math.round(Math.floor(Math.random()*e.height)+e.y);while(null===r(n,a)[2]&&o++<30);return t.x=n,t.y=a,t},n(e,r)},b=function(t,e,n){var r=t[0],a=t[1],o=Math.round(r[0]),i=Math.max(Math.floor(r[1],0),0),f=(Math.min(Math.ceil(a[0],e),e-1),Math.min(Math.ceil(a[1],n),n-1));return{x:o,y:i,xMax:e,yMax:f,width:e,height:n}},M=function(t){return t/180*Math.PI},x=function(t){return t/(Math.PI/180)},_=function(t,e,n){var r=n.east-n.west,a=n.width/x(r)*360/(2*Math.PI),o=a/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),i=n.height+o,f=(i-e)/a,u=180/Math.PI*(2*Math.atan(Math.exp(f))-Math.PI/2),s=x(n.west)+t/n.width*x(r);return[s,u]},O=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},E=function(t,e,n){var r=O(n.south),a=O(n.north),o=n.width/(n.east-n.west),i=n.height/(a-r),f=O(M(t)),u=(M(e)-n.west)*o,f=(a-f)*i;return[u,f]},P=function(t,e,r,a){function o(n){for(var a=[],o=e.y;o<=e.yMax;o+=2){var s=_(n,o,r);if(s){var h=s[0],c=s[1];if(isFinite(h)){var d=t.interpolate(h,c);d&&(d=v(i,h,c,n,o,f,d,r),a[o+1]=a[o]=d)}}}u[n+1]=u[n]=a}var i={},f=n,u=[],s=e.x;!function t(){for(var n=Date.now();s<e.width;)if(o(s),s+=2,Date.now()-n>1e3)return void setTimeout(t,25);w(u,e,a)}()},I=function(n,s){function h(t){return parseInt(l(t).substring(0,2),16)}function c(t){return parseInt(l(t).substring(2,4),16)}function d(t){return parseInt(l(t).substring(4,6),16)}function l(t){return"#"==t.charAt(0)?t.substring(1,7):t}function p(t,e){var n=["rgba("+h("#00ffff")+", "+c("#00ffff")+", "+d("#00ffff")+", 0.5)","rgba("+h("#64f0ff")+", "+c("#64f0ff")+", "+d("#64f0ff")+", 0.5)","rgba("+h("#87e1ff")+", "+c("#87e1ff")+", "+d("#87e1ff")+", 0.5)","rgba("+h("#a0d0ff")+", "+c("#a0d0ff")+", "+d("#a0d0ff")+", 0.5)","rgba("+h("#b5c0ff")+", "+c("#b5c0ff")+", "+d("#b5c0ff")+", 0.5)","rgba("+h("#c6adff")+", "+c("#c6adff")+", "+d("#c6adff")+", 0.5)","rgba("+h("#d49bff")+", "+c("#d49bff")+", "+d("#d49bff")+", 0.5)","rgba("+h("#e185ff")+", "+c("#e185ff")+", "+d("#e185ff")+", 0.5)","rgba("+h("#ec6dff")+", "+c("#ec6dff")+", "+d("#ec6dff")+", 0.5)","rgba("+h("#ff1edb")+", "+c("#ff1edb")+", "+d("#ff1edb")+", 0.5)"];return n.indexFor=function(t){return Math.floor(Math.min(t,e)/e*(n.length-1))},n}function y(){w.forEach(function(t){t.length=0}),x.forEach(function(t){t.age>o&&(s.randomize(t).age=0);var e=t.x,n=t.y,r=s(e,n),a=r[2];if(null===a)t.age=o;else{var i=e+r[0],f=n+r[1];null!==s(i,f)[2]?(t.xt=i,t.yt=f,w[m.indexFor(a)].push(t)):(t.x=i,t.y=f)}t.age+=1})}function v(){var t=O.globalCompositeOperation;O.globalCompositeOperation="destination-in",O.fillRect(n.x,n.y,n.width,n.height),O.globalCompositeOperation=t,w.forEach(function(t,e){t.length>0&&(O.beginPath(),O.strokeStyle=m[e],t.forEach(function(t){O.moveTo(t.x,t.y),O.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),O.stroke())})}var m=p(r,a),w=m.map(function(){return[]}),b=Math.round(n.width*n.height*f);g()&&(b*=u);for(var M="rgba(0, 0, 0, 0.97)",x=[],_=0;_<b;_++)x.push(s.randomize({age:Math.floor(Math.random()*o)+0}));var O=t.canvas.getContext("2d");O.lineWidth=i,O.fillStyle=M,function n(){y(),v(),t.onDraw(),D.timer=e.Util.requestAnimFrame(n)}()},C=function(e,n,r,a){var o={south:M(a[0][1]),north:M(a[1][1]),east:M(a[1][0]),west:M(a[0][0]),width:n,height:r};k(),l(t.data,function(t){P(t,b(e,n,r),o,function(t,e){D.field=e,I(t,e)})})},k=function(){D.field&&D.field.release(),D.timer&&e.Util.cancelAnimFrame(D.timer)},D={params:t,start:C,stop:k};return D}function r(t,e){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var a=n[r],o=Object.getOwnPropertyDescriptor(e,a);o&&o.configurable&&void 0===t[a]&&Object.defineProperty(t,a,o)}return t}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var f=function(t){function e(n,r,i){a(this,e);var f=o(this,t.call(this,n,i));return f._data=r,f}return i(e,t),e.prototype.getData=function(){return this._data},e.prototype.setData=function(t){return this._data=t,this.redraw(),this},e.prototype.redraw=function(){return this._getRenderer()&&this._getRenderer()._redraw(),this},e.prototype.toJSON=function(){return{type:"WindyLayer",id:this.getId(),options:this.config(),data:this.getData()}},e.fromJSON=function(t){if(!t||"WindyLayer"!==t.type)return null;var n=new e(t.id,t.data,t.options);return n},e}(e.Layer);f.registerRenderer("canvas",function(t){function e(){return a(this,e),o(this,t.apply(this,arguments))}return i(e,t),e.prototype.draw=function(){var t=this;this.canvas?(this.prepareCanvas(),this._windy.start.apply(this._windy,this._getWindExtents())):(this.prepareCanvas(),this._windy=new n({canvas:this.canvas,data:this.layer.getData(),onDraw:function(){t.requestMapToRender()}}),this._windy.start.apply(this._windy,this._getWindExtents()))},e.prototype.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);return this.log&&console.log(e),this.log=!1,e},e.prototype._getWindExtents=function(){var t=this.getMap(),e=t.getExtent();return console.log(e),[[[0,0],[t.width,t.height]],t.width,t.height,[[e.xmin,e.ymin],[e.xmax,e.ymax]]]},e.prototype._redraw=function(){this.prepareRender(),this.draw()},e.prototype.onRemove=function(){this._windy.stop(),delete this._windy},e.prototype.onMoveStart=function(){this.log=!0,this._windy.stop()},e.prototype.onZoomStart=function(){this._windy.stop()},e.prototype.onZoomEnd=function(e){this.log=!0,t.prototype.onZoomEnd.call(this,e)},e}(e.renderer.CanvasRenderer)),t.WindyLayer=f,Object.defineProperty(t,"__esModule",{value:!0})});